"""
í†µí•© ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ í•œ ë²ˆì— ì‹¤í–‰í•˜ëŠ” ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸
"""

import os
from dotenv import load_dotenv
from data_preprocessing import load_and_preprocess_data, load_multiple_departments
from rag_pipeline import setup_rag_pipeline, query_rag
from langgraph_agent import run_agent


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    
    # í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
    load_dotenv()
    
    print("="*80)
    print("ë°˜ë ¤ë™ë¬¼ ê±´ê°• ìƒë‹´ ì±—ë´‡ ì‹œìŠ¤í…œ")
    print("="*80)
    
    # ========================================================================
    # 1ë‹¨ê³„: ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬
    # ========================================================================
    print("\n[1ë‹¨ê³„] ë°ì´í„° ë¡œë“œ ë° ì „ì²˜ë¦¬ ì¤‘...")
    
    # ë°ì´í„° ê²½ë¡œ ì„¤ì • (ì‹¤ì œ í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
    base_path = r"c:\LDG_CODES\SKN20\3rd_prj\data\59.ë°˜ë ¤ê²¬ ì„±ì¥ ë° ì§ˆë³‘ ê´€ë ¨ ë§ë­‰ì¹˜ ë°ì´í„°\3.ê°œë°©ë°ì´í„°\1.ë°ì´í„°\Training\01.ì›ì²œë°ì´í„°"
    
    # ì—¬ëŸ¬ ì§„ë£Œê³¼ ë°ì´í„° ë¡œë“œ
    documents = load_multiple_departments(
        base_path=base_path,
        departments=["ë‚´ê³¼", "ì™¸ê³¼", "ì•ˆê³¼", "ì¹˜ê³¼", "í”¼ë¶€ê³¼"],  # ëª¨ë“  ì§„ë£Œê³¼ ë¡œë“œ
        data_type="source",
        chunk_size=1000,
        chunk_overlap=200
    )
    
    if not documents:
        print("âš ï¸ ë¬¸ì„œë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„° ê²½ë¡œë¥¼ í™•ì¸í•˜ì„¸ìš”.")
        return
    
    print(f"âœ“ ì´ {len(documents)}ê°œì˜ ë¬¸ì„œ ì²­í¬ ë¡œë“œ ì™„ë£Œ")
    
    # ========================================================================
    # 2ë‹¨ê³„: RAG íŒŒì´í”„ë¼ì¸ êµ¬ì¶•
    # ========================================================================
    print("\n[2ë‹¨ê³„] RAG íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ì¤‘...")
    
    rag_components = setup_rag_pipeline(
        documents=documents,
        embedding_model="text-embedding-3-small",
        model_name="gpt-4o-mini",
        persist_directory="./chroma_db",
        use_existing_vectorstore=False,  # ì²« ì‹¤í–‰ ì‹œ False, ì´í›„ Trueë¡œ ë³€ê²½ ê°€ëŠ¥
        k=4
    )
    
    print("âœ“ RAG íŒŒì´í”„ë¼ì¸ êµ¬ì¶• ì™„ë£Œ")
    
    # ========================================================================
    # 3ë‹¨ê³„: RAG íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸
    # ========================================================================
    print("\n[3ë‹¨ê³„] RAG íŒŒì´í”„ë¼ì¸ í…ŒìŠ¤íŠ¸...")
    
    test_query = "ê°•ì•„ì§€ê°€ êµ¬í† ë¥¼ í•˜ê³  í™©ë‹¬ ì¦ìƒì´ ìˆìŠµë‹ˆë‹¤. ì–´ë–¤ ì§ˆí™˜ì¼ê¹Œìš”?"
    print(f"\ní…ŒìŠ¤íŠ¸ ì§ˆë¬¸: {test_query}")
    
    answer = query_rag(rag_components["chain"], test_query)
    print(f"\nRAG ë‹µë³€:\n{answer}")
    
    # ========================================================================
    # 4ë‹¨ê³„: LangGraph Agent ì‹¤í–‰ (í†µí•© ì›Œí¬í”Œë¡œìš°)
    # ========================================================================
    print("\n\n" + "="*80)
    print("[4ë‹¨ê³„] LangGraph Agent ì›Œí¬í”Œë¡œìš° ì‹¤í–‰")
    print("="*80)
    
    # Agent í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (ë‹¤ì–‘í•œ ì¦ìƒ ë° ê¸°ëŒ€ ì‘ê¸‰ë„)
    agent_test_cases = [
        # ì‘ê¸‰ë„ ë†’ìŒ - ìœ„í—˜í•œ ì¦ìƒ
        {
            "query": "ì €í¬ ê°•ì•„ì§€ê°€ ê°‘ìê¸° êµ¬í† ë¥¼ ì—¬ëŸ¬ ë²ˆ í•˜ê³  ë°°ê°€ ë¶€í’€ì–´ ì˜¬ëì–´ìš”. ë§¤ìš° ì•„íŒŒ ë³´ì…ë‹ˆë‹¤.",
            "expected_urgency": "ë†’ìŒ",
            "reason": "ìœ„ í™•ì¥/ë¹„í‹€ë¦¼ ì˜ì‹¬, ìƒëª… ìœ„í˜‘"
        },
        {
            "query": "ê°•ì•„ì§€ê°€ í˜¸í¡ì´ ê±°ì¹ ê³  ì…ìˆ ì´ íŒŒë˜ì¡Œì–´ìš”. ê³„ì† í—ë–¡ì´ê³  ìˆìŠµë‹ˆë‹¤.",
            "expected_urgency": "ë†’ìŒ",
            "reason": "ì²­ìƒ‰ì¦, í˜¸í¡ê³¤ë€, ì¦‰ê° ì¹˜ë£Œ í•„ìš”"
        },
        
        # ì‘ê¸‰ë„ ë³´í†µ - ë©°ì¹  ë‚´ ì§„ë£Œ í•„ìš”
        {
            "query": "ê³ ì–‘ì´ ëˆˆì´ ì•½ê°„ ì¶©í˜ˆë˜ì—ˆëŠ”ë° í‰ì†Œì™€ ë‹¤ë¥¼ ê²Œ ì—†ì–´ìš”.",
            "expected_urgency": "ë³´í†µ",
            "reason": "ê²½ë¯¸í•œ ì•ˆê³¼ ì¦ìƒ, 1-2ì¼ ë‚´ ì§„ë£Œ"
        },
        {
            "query": "ê°•ì•„ì§€ê°€ ì–´ì œë¶€í„° ê°€ë”ì”© ê¸°ì¹¨ì„ í•©ë‹ˆë‹¤. ì»¨ë””ì…˜ì€ ê´œì°®ì€ ê²ƒ ê°™ì•„ìš”.",
            "expected_urgency": "ë³´í†µ",
            "reason": "í˜¸í¡ê¸° ì¦ìƒ, 2-3ì¼ ë‚´ ê²€ì§„ ê¶Œì¥"
        },
        {
            "query": "ë°˜ë ¤ê²¬ì´ ì˜¤ë¥¸ìª½ ê·€ë¥¼ ìì£¼ ê¸ê³  ë¨¸ë¦¬ë¥¼ í”ë“¤ì–´ìš”.",
            "expected_urgency": "ë³´í†µ",
            "reason": "ì™¸ì´ë„ì—¼/ê·€ ê°ì—¼ ì˜ì‹¬, ì¼ì£¼ì¼ ë‚´ ì§„ë£Œ"
        },
        
        # ì‘ê¸‰ë„ ë‚®ìŒ - ê²½ë¯¸í•œ ì¦ìƒ
        {
            "query": "ê°•ì•„ì§€ ë°œí†±ì´ ë„ˆë¬´ ê¸¸ì–´ì§„ ê²ƒ ê°™ì€ë° ì–¸ì œ ë³‘ì› ê°€ì•¼ í• ê¹Œìš”?",
            "expected_urgency": "ë‚®ìŒ",
            "reason": "ì¼ìƒ ê´€ë¦¬, ë¹„ì‘ê¸‰"
        },
        {
            "query": "ê³ ì–‘ì´ê°€ í‰ì†Œë³´ë‹¤ ë¬¼ì„ ì¡°ê¸ˆ ë” ë§ì´ ë§ˆì‹œëŠ” ê²ƒ ê°™ì•„ìš”. ë‹¤ë¥¸ ì¦ìƒì€ ì—†ìŠµë‹ˆë‹¤.",
            "expected_urgency": "ë‚®ìŒ",
            "reason": "ê²½ë¯¸í•œ ë³€í™”, ê´€ì°° í›„ íŒë‹¨"
        },
        
        # í”¼ë¶€ê³¼ ê´€ë ¨
        {
            "query": "ê°•ì•„ì§€ ë°° ìª½ì— ë¶‰ì€ ë°˜ì ì´ ìƒê²¼ê³  ê°€ë ¤ì›Œí•˜ëŠ” ê²ƒ ê°™ì•„ìš”.",
            "expected_urgency": "ë³´í†µ",
            "reason": "í”¼ë¶€ ì—¼ì¦/ì•Œë ˆë¥´ê¸°, ì¼ì£¼ì¼ ë‚´ ì§„ë£Œ"
        },
        
        # ì¹˜ê³¼ ê´€ë ¨
        {
            "query": "ê°•ì•„ì§€ ì…ì—ì„œ ëƒ„ìƒˆê°€ ë§ì´ ë‚˜ê³  ì¹˜ì•„ì— ëˆ„ëŸ° ë•Œê°€ ë¼ì–´ìˆì–´ìš”.",
            "expected_urgency": "ë³´í†µ",
            "reason": "ì¹˜ì„/ì¹˜ì£¼ì§ˆí™˜, ìŠ¤ì¼€ì¼ë§ í•„ìš”"
        },
    ]
    
    for i, test_case in enumerate(agent_test_cases, 1):
        query = test_case["query"]
        expected_urgency = test_case["expected_urgency"]
        reason = test_case["reason"]
        
        print(f"\n\n{'â”€'*80}")
        print(f"Agent í…ŒìŠ¤íŠ¸ {i}: {query}")
        print(f"ê¸°ëŒ€ ì‘ê¸‰ë„: {expected_urgency} ({reason})")
        print('â”€'*80)
        
        result = run_agent(
            user_query=query,
            config={"configurable": {"thread_id": f"test_{i}"}}
        )
        
        # ê²°ê³¼ ì¶œë ¥
        print("\n" + "â”Œ" + "â”€"*78 + "â”")
        print("â”‚ ìµœì¢… ì‘ë‹µ" + " "*68 + "â”‚")
        print("â””" + "â”€"*78 + "â”˜")
        print(result.get("final_response", "ì‘ë‹µ ìƒì„± ì‹¤íŒ¨"))
        
        # íŒë‹¨ ê²°ê³¼ ë° ì •í™•ë„ í‘œì‹œ
        actual_urgency = result.get('urgency_level', 'N/A')
        is_correct = actual_urgency == expected_urgency
        correctness = "âœ… ì •ë‹µ" if is_correct else "âŒ ì˜¤ë‹µ"
        
        print("\n" + "â”Œ" + "â”€"*78 + "â”")
        print(f"â”‚ íŒë‹¨ ê²°ê³¼" + " "*66 + "â”‚")
        print("â””" + "â”€"*78 + "â”˜")
        print(f"ê¸°ëŒ€ ì‘ê¸‰ë„: {expected_urgency} | ì‹¤ì œ ì‘ê¸‰ë„: {actual_urgency} | {correctness}")
        print(f"ì¶”ì²œ ì§„ë£Œê³¼: {result.get('recommended_department', 'N/A')}")
        
        if result.get("hospital_list"):
            print(f"ì¶”ì²œ ë³‘ì› ìˆ˜: {len(result['hospital_list'])}ê°œ")
    
    # ========================================================================
    # ì™„ë£Œ
    # ========================================================================
    print("\n\n" + "="*80)
    print("ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
    print("="*80)
    
    print("\nğŸ“ ë‹¤ìŒ ë‹¨ê³„:")
    print("1. ì‹¤ì œ ë°ì´í„° ê²½ë¡œë¡œ ë³€ê²½í•˜ì—¬ ì „ì²´ ë°ì´í„° ë¡œë“œ")
    print("2. ì¹´ì¹´ì˜¤ë§µ API ì—°ë™í•˜ì—¬ ì‹¤ì œ ë³‘ì› ê²€ìƒ‰ êµ¬í˜„")
    print("3. ì›¹ ì¸í„°í˜ì´ìŠ¤ ë˜ëŠ” ì±—ë´‡ UI ê°œë°œ")
    print("4. ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ë° ëª¨ë¸ ê°œì„ ")


if __name__ == "__main__":
    main()
